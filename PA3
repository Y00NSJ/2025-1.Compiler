%{
#include <stdio.h>
#include "ast.h"
int yylex(void);
int yyerror(char*);
STACK *stack;
%}

%start Program
%union{
	int iVal;
	float rVal;
	char* sVal;
}
%token TEOF TBREAK TCASE TCHAR TDEFAULT TDO TELSE TFLOAT TFOR TIF TINT TRETURN TSWITCH TVOID TWHILE TCOMMENT TOPERATOR TPUNCTUATION TERROR TPLUSASSIGN TMINUSASSIGN TMULASSIGN TDIVASSIGN TMODASSIGN TEQ TNE TOR TAND TGE TLE TINC TDEC TCOMMA TLPAREN TRPAREN TSEMI TCOLON TLBRACE TRBRACE TLBRACKET TRBRACKET TPLUS TMINUS TMUL TDIV TMOD TLT TGT
%token<iVal> TINTEGER
%token<rVal> TREAL
%token<sVal> TIDENTIFIER TSTRING

%nonassoc LOWCOMMA
%left TCOMMA

%%


Program : Program ExternalDec {
	edNode = pop();
	pNode = pop();
	if (getChild(pNode)) {
		setLastSibling(getChild(pNode), edNode);
		push(pNode);
	}
}
	| ExternalDec {
		edNode = pop();
		push(setChild(makeASTNode(_PROG), setSibling(pop(), edNode)));
		}
	;

ExternalDec : Dec {}
	    | FuncDef {}
	    ;

FuncDef : VarType TIDENTIFIER TLPAREN Params TRPAREN CpndStmt {}
	| TVOID TIDENTIFIER TLPAREN Params TRPAREN CpndStmt {}
	;

Dec : VarType TIDENTIFIER TLPAREN Params TRPAREN TSEMI {}
	| TVOID TIDENTIFIER TLPAREN Params TRPAREN TSEMI {}
	| VarDec {}
	;

Params : ParamList {}
	| TVOID {}
	| {}
	;

ParamList : ParamList TCOMMA Param { printf("ParamList -> ParamList , Param\n"); }
	  | Param { printf("ParamList -> Param\n"); }
	  ;

Param : VarType Declarator { printf("Param -> VarType Declarator\n"); }
	;

CpndStmt : TLBRACE LDecList StmtList TRBRACE { printf("CpndStmt -> { LDecList StmtList }\n"); }
	 ;

LDecList : LDecList VarDec { printf("LDecList -> LDecList VarDec\n"); }
	 | { printf("LDecList -> Empty\n"); }

VarDec : VarType IDDecList TSEMI { printf("VarDec -> VarType IDDecList ;\n"); }
	;

VarType : TINT	{ printf("VarType -> int\n"); }
	| TCHAR { printf("VarType -> char\n"); }
	| TFLOAT { printf("VarType -> float\n"); }
	;

IDDecList : IDDecList TCOMMA IDDec { printf("IDDecList -> IDDecList , IDDec\n"); }
	  | IDDec { printf("IDDecList -> IDDec\n"); }
	  ;

IDDec: Declarator TOPERATOR Initializer { printf("IDDec -> Declarator = Initializer\n"); }
	| Declarator { printf("IDDec -> Declarator\n"); }
	;

Declarator : TIDENTIFIER TLBRACKET TINTEGER TRBRACKET { printf("Declarator -> %s [ %d ]\n", $1, $3); }
	   | TIDENTIFIER { printf("Declarator -> %s\n", $1); free($1); }
	   ;

Initializer : AssignExpr { printf("Initializer -> AssignExpr\n"); }
	    | TLBRACE InitializerList TRBRACE { printf("Initializer -> { InitializerList }\n"); }
	    ;

InitializerList : InitializerList TCOMMA Initializer %prec LOWCOMMA { printf("InitializerList -> InitializerList , Initializer\n"); }
		| Initializer { printf("InitializerList -> Initializer\n"); }
		;

StmtList : StmtList Stmt { printf("StmtList -> StmtList Stmt\n"); }
	 | { printf("StmtList -> Empty\n"); }
	 ;

Stmt : MatchedStmt { printf("Stmt -> MatchedStmt\n"); }
     | OpenStmt { printf("Stmt -> OpenStmt\n"); }
     ;

MatchedStmt : ExprStmt		{ printf("MatchedStmt -> ExprStmt\n"); }
	    | ForMatchedStmt	{ printf("MatchedStmt -> ForMatchedStmt\n"); }
	    | WhileMatchedStmt	{ printf("MatchedStmt -> WhileMatchedStmt\n"); }
	    | DoWhileStmt	{ printf("MatchedStmt -> DoWhileStmt\n"); }
	    | ReturnStmt	{ printf("MatchedStmt -> ReturnStmt\n"); }
	    | CpndStmt		{ printf("MatchedStmt -> CpndStmt\n"); }
	    | BreakStmt		{ printf("MatchedStmt -> BreakStmt\n"); }
	    | SwitchStmt	{ printf("MatchedStmt -> SwitchStmt\n"); }
	    | TIF TLPAREN Expr TRPAREN MatchedStmt TELSE MatchedStmt { printf("MatchedStmt -> if ( Expr ) MatchedStmt else MatchedStmt\n");}
	    ;

OpenStmt : ForOpenStmt { printf("OpenStmt -> ForOpenStmt\n"); }
	 | WhileOpenStmt { printf("OpenStmt -> WhileOpenStmt\n"); }
	 | TIF TLPAREN Expr TRPAREN Stmt { printf("OpenStmt -> if ( Expr ) Stmt\n"); }
	 | TIF TLPAREN Expr TRPAREN MatchedStmt TELSE OpenStmt	{ printf("OpenStmt -> if ( Expr ) MatchedStmt else OpenStmt\n"); }
	 ;

SwitchStmt : TSWITCH TLPAREN Expr TRPAREN TLBRACE CaseList DefaultCase TRBRACE { printf("SwitchStmt -> switch ( Expr ) { CaseList DefaultCase }\n"); }
	   ;

CaseList : CaseList TCASE TINTEGER TCOLON StmtList { printf("CaseList -> CaseList case %d : StmtList\n", $3); }
	 | TCASE TINTEGER TCOLON StmtList { printf("CaseList -> case %d : StmtList\n", $2); }
	 ;

DefaultCase : TDEFAULT TCOLON StmtList { printf("DefaultCase -> default : StmtList\n"); }
	    | { printf("DefaultCase -> Empty\n"); }
	    ;

ReturnStmt : TRETURN Expr TSEMI { printf("ReturnStmt -> return Expr ;\n"); }
	   | TRETURN TSEMI { printf("ReturnStmt -> return ;\n"); }
	   ;

BreakStmt : TBREAK TSEMI { printf("BreakStmt -> break ;\n"); }
	  ;

ExprStmt : Expr TSEMI { printf("ExprStmt -> Expr ;\n"); }
	 | TSEMI { printf("ExprStmt -> ;\n"); }
	 ;

Expr : Expr TCOMMA AssignExpr { printf("Expr -> Expr , AssignExpr\n"); }
     | AssignExpr { printf("Expr -> AssignExpr\n"); }
     ;

AssignExpr : Variable TOPERATOR AssignExpr { printf("AssignExpr -> Variable = AssignExpr\n"); }
	   | Variable TPLUSASSIGN AssignExpr { printf("AssignExpr -> Variable += AssignExpr\n"); }
	   | Variable TMINUSASSIGN AssignExpr { printf("AssignExpr -> Variable -= AssignExpr\n"); }
	   | Variable TMULASSIGN AssignExpr { printf("AssignExpr -> Variable *= AssignExpr\n"); }
	   | Variable TDIVASSIGN AssignExpr { printf("AssignExpr -> Variable /= AssignExpr\n"); }
	   | Variable TMODASSIGN AssignExpr { printf("AssignExpr -> Variable %%= AssignExpr\n"); }
	   | SimpleExpr { printf("AssignExpr -> SimpleExpr\n"); }
	   ;

Variable : TIDENTIFIER TLBRACKET Expr TLBRACKET { printf("Variable -> %s [ Expr ]\n", $1); free($1); }
	 | TIDENTIFIER { printf("Variable -> %s\n", $1); free($1); }
	 ;

SimpleExpr : SimpleExpr TOR AndExpr { printf("SimpleExpr -> SimpleExpr || AndExpr\n"); }
	   | AndExpr { printf("SimpleExpr -> AndExpr\n"); }
	   ;

AndExpr : AndExpr TAND EqualityExpr { printf("AndExpr -> AndExpr && EqualityExpr\n"); }
	| EqualityExpr { printf("AndExpr -> EqualityExpr\n"); }
	;

EqualityExpr : EqualityExpr TEQ RelExpr { printf("EqualityExpr -> EqualityExpr == RelExpr\n"); }
	     | EqualityExpr TNE RelExpr { printf("EqualityExpr -> EqualityExpr != RelExpr\n"); }
	     | RelExpr { printf("EqualityExpr -> RelExpr\n"); }
	     ;

RelExpr : RelExpr TLT AddExpr { printf("RelExpr -> RelExpr < AddExpr\n"); }
	| RelExpr TLE AddExpr { printf("RelExpr -> RelExpr <= AddExpr\n"); }
	| RelExpr TGT AddExpr { printf("RelExpr -> RelExpr > AddExpr\n"); }
	| RelExpr TGE AddExpr { printf("RelExpr -> RelExpr >= AddExpr\n"); }
	| AddExpr { printf("RelExpr -> AddExpr\n"); }
	;

AddExpr : AddExpr TPLUS Term { printf("AddExpr -> AddExpr + Term\n"); }
	| AddExpr TMINUS Term { printf("AddExpr -> AddExpr - Term\n"); }
	| Term		   { printf("AddExpr -> Term\n"); }
	;

Term : Term TMUL Factor { printf("Term -> Term * Factor\n"); }
	| Term TDIV Factor { printf("Term -> Term / Factor\n"); }
	| Term TMOD Factor { printf("Term -> Term %% Factor\n"); }
	| Factor { printf("Term -> Factor\n"); }
	;

Factor : TLPAREN Expr TRPAREN { printf("Factor -> ( Expr )\n"); }
	| FuncCall { printf("Factor -> FuncCall\n"); }
	| TMINUS Factor { printf("Factor -> - Factor\n"); }
	| Variable { printf("Factor -> Variable\n"); }
	| Variable IncDec { printf("Factor -> Variable IncDec\n"); }
	| IncDec Variable { printf("Factor -> IncDec Variable\n"); }
	| NumberLiteral { printf("Factor -> NumberLiteral\n"); }
	;

NumberLiteral : TINTEGER {}
		| TREAL {}
		;

IncDec : TINC {}
	| TDEC {}
	;

WhileMatchedStmt : TWHILE TLPAREN Expr TRPAREN MatchedStmt {}
		 ;

WhileOpenStmt : TWHILE TLPAREN Expr TRPAREN OpenStmt {}
		;

DoWhileStmt : TDO Stmt TWHILE TLPAREN Expr TRPAREN TSEMI {}
		;

ForMatchedStmt : TFOR TLPAREN ExprStmt ExprStmt Expr TRPAREN MatchedStmt {}
		;

ForOpenStmt : TFOR TLPAREN ExprStmt ExprStmt Expr TRPAREN OpenStmt {}
		;

FuncCall : TIDENTIFIER TLPAREN Arguments TRPAREN {}
	 ;

Arguments : ArgumentList {}
	  | {}
	  ;

ArgumentList : ArgumentList TCOMMA AssignExpr {}
	     | ArgumentList TCOMMA TSTRING {}
	     | AssignExpr {}
	     | TSTRING {}
	     ;


%%

int main(int argc, char* argv[]){
	extern FILE *yyin;
	ASTNode* root = 0;
	stack = initStack();
	yyin = fopen(argv[1], "r");
	yyparse();
	fclose(yyin);
	printAST(root = pop(stack));
	if (root) {
		delAST(root);
		root = 0;
	}
	delStack(stack);
	return 0;
}

int yyerror(char* s){
	printf("%s\n", s);
	return 0;
}
